name: CI Call API NTK on Push TAG
on:
  workflow_call:

jobs:
  logLatestRelease:
    name: Call API
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    # permissions:
    #   contents: read
    #   packages: write
    steps:
      - uses: octokit/request-action@v2.x
        id: get_latest_release
        with:
          route: GET /repos/{owner}/{repo}/releases/latest
          owner: novaittestteam
          repo: ntk.mob
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete Tag
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          #delete_release: false # default: false
          tag_name: ${{ github.ref_name }} # tag name to delete
          #repo: ${{ github.repository_owner }}/${{ env.REP_NAME }} # target repo (optional). defaults to repo running this action
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: octokit/request-action@v2.x
        id: push_tag
        with:
          route: POST /repos/{owner}/{repo}/git/tags
          owner: novaittestteam
          repo: ntk.mob
          body: ${{ toJSON(env.REQUEST_BODY) }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REQUEST_BODY: |
            {"tag":"build-apk","message":"Auto API Call","object":"8ca53e0a330bc36b53a9d5ad1e38f3cd520a4acd","type":"commit","tagger":{"name":"pilganchuk","email":"aleksei.pilganchuk@novait.com.ua"}}
      
      - run: "echo Push response: '${{ steps.push_tag.outputs.data }}'"

      - run: "echo Push status: '${{ steps.push_tag.outputs.status }}'"
        if: ${{ failure() }}