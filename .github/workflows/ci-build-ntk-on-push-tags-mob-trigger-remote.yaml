name: CI Call API NTK on Push TAG
on:
  workflow_call:

jobs:
  logLatestRelease:
    name: Call API
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    # permissions:
    #   contents: read
    #   packages: write
    permissions: write-all
    steps:
      - uses: octokit/request-action@v2.x
        id: get_latest_release
        with:
          route: GET /repos/{owner}/{repo}/releases/latest
          owner: novaittestteam
          repo: ntk.mob
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete Tag
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          #delete_release: false # default: false
          tag_name: ${{ github.ref_name }} # tag name to delete
          #repo: ${{ github.repository_owner }}/${{ env.REP_NAME }} # target repo (optional). defaults to repo running this action
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - uses: octokit/request-action@v2.x
      #   id: push_tag
      #   with:
      #     route: POST /repos/{owner}/{repo}/git/tags
      #     owner: novaittestteam
      #     repo: ntk.mob
      #     body: ${{ toJSON(env.REQUEST_BODY) }}
      #     mediaType: |
      #       format: raw
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     REQUEST_BODY: |
      #       {"tag":"build-apk","message":"Auto API Call","object":"4c64ded9bed5633f4918ea0284be44c4f85541c4","type":"commit","tagger":{"name":"AutoAPICall","email":"support@novait.com.ua"}}

      # - uses: octokit/request-action@v2.x
      #   id: push_tag
      #   with:
      #     route: POST /repos/{owner}/{repo}/git/refs
      #     owner: novaittestteam
      #     repo: ntk.mob
      #     mediaType: |
      #       format: raw
      #   input:  |
      #     ref: refs/heads/build-apk
      #     sha: 4c64ded9bed5633f4918ea0284be44c4f85541c4
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - uses: actions/github-script@v7 #THIS IS WORK
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       github.rest.git.createRef({
      #         owner: context.repo.owner,
      #         repo: 'ntk.mob',
      #         ref: 'refs/tags/build-apk',
      #         sha: '4c64ded9bed5633f4918ea0284be44c4f85541c4'
      #       })

      - uses: actions/github-script@v7 
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          debug: true
          script: |
            const owner = 'novaittestteam'
            const repo = 'ntk.mob'
            const files = [{
              mode: '100644',
              path: 'src/file1.txt',
              content: 'Hello world 1', //whatever
            },{
                  mode: '100644',
                  path: 'version.json',
                  content: '{"test"":"1.1"}',
            }];

            async function getLastCommit() {
              try {
                await github.rest.repos.listCommits({
                    owner,
                    repo,
                });
              } catch (err) {
              console.log('Error: ' + err)
              }
            };
            getLastCommit()
              .then((data) => console.log('SHA' + data[0].sha));
            





      # - uses: actions/github-script@v6
      #   with:
      #       script: |
      #         await github.rest.actions.createworkflowDispatch({
      #             owner: 'guidemetothemoon',
      #             repo: 'ntk.mob',
      #             workflow_id: 'repob-workflow.yml',
      #             ref: 'main'
      #         })  

      # - run: "echo Push response: '${{ steps.push_tag.outputs.data }}'"

      # - run: "echo Push status: '${{ steps.push_tag.outputs.status }}'"
      #   if: ${{ failure() }}