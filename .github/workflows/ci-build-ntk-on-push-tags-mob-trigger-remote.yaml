name: CI Call API NTK on Push TAG
on:
  workflow_call:

jobs:
  logLatestRelease:
    name: Call API
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    # permissions:
    #   contents: read
    #   packages: write
    permissions: write-all
    steps:
      - uses: octokit/request-action@v2.x
        id: get_latest_release
        with:
          route: GET /repos/{owner}/{repo}/releases/latest
          owner: novaittestteam
          repo: ntk.mob
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete Tag
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          #delete_release: false # default: false
          tag_name: ${{ github.ref_name }} # tag name to delete
          #repo: ${{ github.repository_owner }}/${{ env.REP_NAME }} # target repo (optional). defaults to repo running this action
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - uses: octokit/request-action@v2.x
      #   id: push_tag
      #   with:
      #     route: POST /repos/{owner}/{repo}/git/tags
      #     owner: novaittestteam
      #     repo: ntk.mob
      #     body: ${{ toJSON(env.REQUEST_BODY) }}
      #     mediaType: |
      #       format: raw
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     REQUEST_BODY: |
      #       {"tag":"build-apk","message":"Auto API Call","object":"4c64ded9bed5633f4918ea0284be44c4f85541c4","type":"commit","tagger":{"name":"AutoAPICall","email":"support@novait.com.ua"}}

      - uses: octokit/request-action@v2.x
        id: push_tag
        with:
          route: POST /repos/{owner}/{repo}/git/refs
          owner: novaittestteam
          repo: ntk.mob
          body:  |
            "ref":"refs/heads/build-apk"
            "sha":"4c64ded9bed5633f4918ea0284be44c4f85541c4"
          mediaType: |
            format: raw
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REQUEST_BODY: |
            |
            {"ref":"refs/heads/build-apk","sha":"4c64ded9bed5633f4918ea0284be44c4f85541c4"}



      - run: "echo Push response: '${{ steps.push_tag.outputs.data }}'"

      - run: "echo Push status: '${{ steps.push_tag.outputs.status }}'"
        if: ${{ failure() }}